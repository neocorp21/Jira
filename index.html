<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validación de Cookie - Cliente Apps Script API</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        input[type="text"] { width: 100%; padding: 12px; margin: 10px 0 20px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #a8c8e6; cursor: not-allowed; }
        #resultado { margin-top: 20px; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-size: 0.9em; overflow-x: auto; }
        .success { background-color: #e6ffe6; border: 1px solid #00cc00; color: #008000; }
        .error { background-color: #ffe6e6; border: 1px solid #cc0000; color: #cc0000; }
        .info { background-color: #ccf2ff; border: 1px solid #0099cc; color: #006699; }
    </style>
</head>
<body>
    
    <div class="container">
        <h1>Validación de Cookie vía Apps Script API</h1>

        <p>Ingresa la cookie de sesión de Jira y valida a través de tu proxy seguro en Google:</p>
        <input type="text" id="cookieInput" placeholder="Pega el valor de la cookie aquí" onkeydown="if (event.key === 'Enter') validarCookie()">

        <button onclick="validarCookie()" id="submitBtn">Validar Cookie</button>

        <pre id="resultado" class="info">Esperando datos...</pre>
    </div>

    <script>
        // ⭐️ ENDPOINT DE LA APLICACIÓN WEB DE APPS SCRIPT ⭐️
        const API_ENDPOINT_URL = 'https://script.google.com/a/macros/bbva.com/s/AKfycbwWApHPf5WEhlXEbbFwaMAlwwfjEM4M0vY137UMB-SKVF80QeSKg6BfCnAJide9Pg3nKg/exec';
        
        const cookieInput = document.getElementById('cookieInput');
        const resultadoPre = document.getElementById('resultado');
        const submitBtn = document.getElementById('submitBtn');

        function mostrarResultado(message, type) {
            resultadoPre.textContent = message;
            resultadoPre.className = type;
        }

        /**
         * Realiza la invocación POST a la API de Apps Script.
         */
        async function validarCookie() {
            const cookieValue = cookieInput.value.trim();

            if (!cookieValue) {
                mostrarResultado('Error: Ingresa la cookie de sesión.', 'error');
                return;
            }

            submitBtn.disabled = true;
            mostrarResultado('Cargando... Enviando solicitud POST al servidor de Google.', 'info');

            const options = {
                method: 'POST', // ⭐️ Método POST obligatorio para Apps Script doPost() ⭐️
                headers: {
                    'Content-Type': 'application/json' // Indica que el cuerpo es JSON
                },
                // El cuerpo transporta la cookie al servidor de Apps Script
                body: JSON.stringify({
                    cookie: cookieValue
                })
            };

            try {
                // 1. Llamada a tu API de Apps Script
                const response = await fetch(API_ENDPOINT_URL, options);
                
                // 2. Leer la respuesta JSON
                const responseBody = await response.json();

                // 3. Manejo del resultado basado en el JSON devuelto por doPost
                if (responseBody.error) {
                    mostrarResultado(`❌ Error de Validación: ${responseBody.message}`, 'error');
                } else if (responseBody.success) {
                    const userData = responseBody.userData;
                    const displayName = userData.displayName || 'Desconocido';
                    mostrarResultado(
                        `✅ Validación Exitosa!\nConectado como: ${displayName}\n\nDatos Completos:\n${JSON.stringify(userData, null, 2)}`, 
                        'success'
                    );
                } else {
                    mostrarResultado('Error: Respuesta inesperada del servidor.', 'error');
                }

            } catch (error) {
                mostrarResultado(`❌ Fallo en la comunicación: ${error.message}. Verifica tu conexión o el despliegue del script.`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
